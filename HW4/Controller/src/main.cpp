#include <Arduino.h>
#include "frame_builder.h"
#include "bit_stuff_control.h"
#include "frame_control.h"

bool rx[128] = { 0 };
int current_state;

const char PROGMEM test_frames[][256] = {
  "0110011100100001000101010101010101010101010101010101010101010101010101010101010101000001000010100011011111111",
  "011001110010000011111001010101010101010101010101010101010101010101010101010101011001100111011011111111",
  "011001110010000011101010101010101010101010101010101010101010101010100001001001011101011111111",
  "0110011100100000110110101010101010101010101010101010101010101100111001001101011111111",
  "01100111001000001100101010101010101010101010101010101110111010100101011111111",
  "0110011100100000101110101010101010101010101001001011100000111011111111",
  "0110011100100000101010101010101010100110110111100111011111111",
  "01100111001000001001101010101100111000010101011111111",
  "011001110010000010000110010110101011011111111",
  "0110011100101000001000001000010100011011111111",
  "011001110010100000110000100100010011011111111",
  "0100010010011111000001000001111100100001000101010101010101010101010101010101010101010101010101010101010101011110111110101011011111111",
  "010001001001111100000100000111110010100100001010011111001101011111111"
};

void test_frame_control() {
  for (int f = 0; f < 13; f++) {
    int frame_size = strlen(test_frames[f]);
    current_state = IDLE;
    string_to_bit_array((char *)test_frames[f], rx);

    for (int i = 0; i < frame_size; i++) {
      check_bit_stuff(rx[i]);
      frame_decoder(rx[i]);
    }

    print_frame(frame);
  }
}

void test_crc() {
  char bit_string[] = "0100010010011111000000000111101000010001010101010101010101010101010101010101010101010101010101010101010";
  int bit_string_size = strlen(bit_string);
  bool bits_array[bit_string_size];
  string_to_bit_array(bit_string, bits_array);
  
  int crc = calculate_crc(bits_array, bit_string_size);
  Serial.print("CRC >>>>> ");
  Serial.println(crc, HEX);
}

void setup() {
  Serial.begin(9600);

  test_frame_control();

  test_crc();
}

void loop() {
  
}